<table id='1' style='font-size:14px'><tr><td></td><td>Algorithm 1: Customized FlashAttention with Max-pooling Kernel</td></tr><tr><td></td><td>Input: Matrices Q,K, V E RNxd in HBM, block sizes Bc, Br Output: Output 0, logsumexp L and attention map D</td></tr><tr><td>1</td><td>N Divide Q into Tr = blocks Q1, . . . , QTr, of size Br x d each Br</td></tr><tr><td>2</td><td>N Divide K, V into Tc blocks K1, . · . , KTc and V1, . · . , VTc, of size Bc x d each Bc</td></tr><tr><td>3</td><td>Divide the output 0 E RNxd into Tr blocks 01, . · · , OTr, of size Br X d each</td></tr><tr><td>4</td><td>Divide the logsumexp L into Tr blocks L1, . . ・ , LTr, of size Br each</td></tr><tr><td>5</td><td>Divide attention score D E RtrxTc into (Tr X Tc) blocks D(⌀) , · · · , D(T⌀ initialize D⌀  (0)1x1</td></tr><tr><td>6</td><td>for i = 1 to Tr do</td></tr><tr><td>7</td><td>Load Qi from HBM to on-chip SRAM</td></tr><tr><td>8</td><td>On chip, initialize 일이 = (0)Brxd, l(o) = (0)Br, mi = (-�)Br ri = (-�)Br</td></tr><tr><td>9</td><td>for j = 1 to Tc do</td></tr><tr><td>10</td><td>Load Kj, Vj from HBM to on-chip SRAM</td></tr><tr><td>11</td><td>On chip, compute S⌀ = QiKT E RBrxBc</td></tr><tr><td>12</td><td>On chip, compute m⌀ = max(m�-1) rowmax(S⌀⌀) ,</td></tr><tr><td>13</td><td>On chip, compute 户(ⓙ = exp( S⌀) - m⌀)</td></tr><tr><td>14</td><td>Update l(j) = l(j-1) + rowsum(P(1)</td></tr><tr><td>15</td><td>On chip, compute O(ⓙ = diag(exp(m.(i-1) - m(�))-10(3-1) + P(j) Vj</td></tr><tr><td>16</td><td>Store r Ⓙ = rowmax ( S⌀) )</td></tr><tr><td>17</td><td>for j = 1 to Tc do</td></tr><tr><td>18</td><td>Update 질㉧ = diag(l(Tc) ) -1 exp(r⌀)  m(Tc))</td></tr><tr><td>19</td><td>On chip, compute D(j) = colmax(r⌀)</td></tr><tr><td>20</td><td>Write D ⌀ to HBM as (i, j)-th block of D</td></tr><tr><td>21</td><td>On chip, compute Oi = diag(liTe) ) -1⌀(Tc)</td></tr><tr><td>22</td><td>On chip, compute Li = m(Ic) + log(l(Tc) )</td></tr><tr><td>23</td><td>Write Oi to HBM as the i-th block of 0</td></tr><tr><td>24</td><td>Write Li to HBM as the i-th block of L</td></tr><tr><td>25</td><td>return 0, L, D</td></tr></table>