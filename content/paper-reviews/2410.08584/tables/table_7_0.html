<table id='0' style='font-size:18px'><tr><td>Algorithm 1: The attention mechanism of ZipVL</td><td></td></tr><tr><td>procedure ZipVL Prefill: Input: Input embedding X, bit-width for important tokens bh, bit-width for other tokens b1 Output: Attention output 0, KV cache (K, V) Calculate query, key and value states (Q,K,V) as per Eq. (1)</td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td>Select a subset of tokens Q' from query states and compute attention scores A' = Softmax (Q/KT) number of important tokens as per Eq. (6)</td></tr><tr><td></td><td>Determine the Calculate the normalized attention scores for each token as per Eq. T for important tokens per Eq. (8) and U for other tokens as per Eq. (9)</td></tr><tr><td></td><td>Select set as set / / Token-level Sparse Attention with FlashAt tention = FlashAttention(Q[T], K[T], V[T])</td></tr><tr><td></td><td>0 // Compressing KV Cache = Concat(Quant(K[T], bh),</td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td>K Quant(K[U],b1)) v = Concat(Quant(V[T], bh), Quant(V[U], b1)) return 0, (K, V)</td><td></td></tr><tr><td>procedure ZipVL Decoding:</td><td></td></tr><tr><td></td><td></td></tr><tr><td>Input: Input embedding x, stored KV cache (Kin, Vin), bit-width for important tokens bh, bit-width for other tokens b1, number of token generated m Attention output cache (Kout, V out) key (q,k,v) as Eq. (1)</td><td></td></tr><tr><td></td><td>the Output: 0, updated KV Calculate query, and value states per Fetch KV cache memory: = Concat(Kin, Concat(V in, v)</td></tr><tr><td>from K k), v = V)</td><td></td></tr><tr><td>Compute attention output 0 = FlashAttention(q, K,</td><td></td></tr><tr><td>/ / Compress new KV cache every 100 tokens generated if m%100 == 0 then attention scores as per set T as per Eq. set U as per Eq. :], V = K'), V out = Concat(V[: -100], V')</td><td></td></tr><tr><td>attention a = Softmax (qKT) [-100 :]</td><td>(8) and</td></tr><tr><td>Compute scores: the number tokens as per</td><td></td></tr><tr><td>Determine of important Eq. (6) Calculate the normalized Eq. Select (9) K = K[-100 V[-100 :] = Concat(Quant(K [T], bh), Quant(K' [U], b1)) = Concat(Quant(V [T], bh), Quant(V [U], b1)) = Concat(K[: -100],</td><td></td></tr><tr><td>V'</td><td></td></tr><tr><td>K' Kout else Kout = K, V out =</td><td></td></tr><tr><td>I v 0, (Kout, V out)</td><td></td></tr><tr><td>return</td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr></table>